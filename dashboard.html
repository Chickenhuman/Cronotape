<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Chrono Tape Dashboard v2</title>
    <style>
        /* [ìŠ¤íƒ€ì¼] ë‹¤í¬ í…Œë§ˆ ë° ë ˆì´ì•„ì›ƒ */
        :root { --bg: #121212; --panel: #1e1e1e; --border: #333; --accent: #ffcc00; --text: #eee; --text-dim: #aaa; }
        body { margin: 0; padding: 0; background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; height: 100vh; display: flex; overflow: hidden; }
        
        .col-list { width: 300px; border-right: 1px solid var(--border); display: flex; flex-direction: column; background: var(--panel); }
        .col-edit { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }
        .col-preview { width: 420px; border-left: 1px solid var(--border); background: #000; display: flex; flex-direction: column; padding: 20px; box-sizing: border-box; }

        h2, h3 { margin: 0; color: var(--accent); font-weight: 600; }
        h3 { font-size: 16px; margin-bottom: 10px; color: #fff; border-bottom: 1px solid #444; padding-bottom: 5px; }
        
        input, select, textarea { background: #2a2a2a; border: 1px solid #444; color: #fff; padding: 8px; border-radius: 4px; width: 100%; box-sizing: border-box; font-family: inherit; margin-bottom: 5px; }
        input:focus, textarea:focus { border-color: var(--accent); outline: none; }
        
        button { background: #333; border: 1px solid #555; color: #fff; padding: 8px 16px; cursor: pointer; border-radius: 4px; transition: 0.2s; font-weight: bold; }
        button:hover { background: #444; border-color: #777; }
        button.primary { background: #2980b9; border-color: #2980b9; }
        button.primary:hover { background: #3498db; }
        button.danger { background: #c0392b; border-color: #c0392b; }

        .tabs { display: flex; border-bottom: 1px solid var(--border); }
        .tab-btn { flex: 1; background: transparent; border: none; padding: 12px; color: var(--text-dim); border-bottom: 2px solid transparent; border-radius: 0; }
        .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); background: rgba(255, 204, 0, 0.05); }
        
        .item-list { flex: 1; overflow-y: auto; }
        .list-item { padding: 12px 15px; border-bottom: 1px solid #2a2a2a; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .list-item:hover { background: #2a2a2a; }
        .list-item.active { background: rgba(255, 204, 0, 0.1); border-left: 3px solid var(--accent); }
        .item-sub { font-size: 11px; color: var(--text-dim); }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-group label { display: block; font-size: 12px; color: var(--text-dim); margin-bottom: 4px; }
        
        /* íƒœê·¸ ì‹œìŠ¤í…œ */
        .tags-container { display: flex; flex-wrap: wrap; gap: 5px; background: #2a2a2a; border: 1px solid #444; padding: 5px; border-radius: 4px; min-height: 36px; }
        .tag { background: #444; padding: 2px 8px; border-radius: 12px; font-size: 12px; display: flex; align-items: center; gap: 5px; }
        .tag-remove { cursor: pointer; color: #ff5555; font-weight: bold; }
        .tag-input { background: transparent; border: none; padding: 0; width: auto; flex: 1; min-width: 60px; color: #fff; }
        .tag-input:focus { outline: none; border: none; }

        /* ë¯¸ë¦¬ë³´ê¸° ì˜ì—­ */
        .preview-area { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; background: url('assets/maps/battle_bg1.png') center/cover; position: relative; border-radius: 8px; margin-bottom: 20px; overflow: hidden; }
        .preview-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.7); pointer-events: none; }
        
        .code-area { height: 180px; display: flex; flex-direction: column; gap: 5px; }
        .code-output { flex: 1; background: #111; color: #0f0; padding: 10px; font-family: monospace; font-size: 11px; resize: none; border: 1px solid #333; }

        /* ì¹´ë“œ ë¯¸ë¦¬ë³´ê¸° ìŠ¤íƒ€ì¼ (ê²Œì„ ë‚´ CSS ëª¨ë°©) */
        .card-preview-wrapper { position: relative; width: 140px; height: 200px; transform: scale(1.5); transform-origin: center; z-index: 10; }
        .card { width: 100%; height: 100%; position: relative; border: 1px solid #444; border-radius: 12px; background: rgba(0,0,0,0.5); }
        .card-bg-img { position: absolute; top: 10%; left: 10%; width: 75%; height: 75%; object-fit: contain; border-radius: 12px; z-index: 1; }
        .card-frame { position: absolute; inset: 0; background-size: 100% 100%; z-index: 2; pointer-events: none; }
        .frame-unit { background-image: url('assets/card_template.png'); }
        .frame-skill { background-image: url('assets/card_template_skill.png'); }
        
        .card-cost { position: absolute; top: 4%; left: 5%; width: 30px; height: 30px; color: #fff; font-weight: 900; font-size: 18px; text-shadow: 0 0 4px #000; display: flex; align-items: center; justify-content: center; z-index: 10; }
        .card-name { position: absolute; top: 50%; left: 50%; transform: translateX(-50%); width: 80%; text-align: center; font-family: serif; font-size: 14px; font-weight: bold; color: #3e2723; text-shadow: 0 1px 1px rgba(255,255,255,0.5); z-index: 10; white-space: nowrap; }
        .card-type { position: absolute; bottom: 15%; width: 100%; text-align: center; font-size: 10px; color: #555; font-weight: bold; z-index: 10; }
        
        .stat-badge { position: absolute; bottom: 3%; width: 30px; height: 30px; color: #fff; font-size: 18px; font-weight: 900; text-shadow: 0 0 4px #000; display: flex; align-items: center; justify-content: center; z-index: 10; }
        .stat-atk { bottom: 7%; left: 5%; color: #fff; }
        .stat-hp { bottom: 7%; right: 5%; color: #fff; }

        .card-traits { position: absolute; top: 64%; left: 50%; transform: translateX(-50%); width: 90%; display: flex; flex-wrap: wrap; justify-content: center; gap: 2px; z-index: 10; }
        .trait-tag { font-size: 9px; padding: 1px 4px; border-radius: 3px; color: #eee; border: 1px solid #aaa; background: rgba(0,0,0,0.6); }
        .tag-race { border-color: #0f0; color: #cfc; background: rgba(0,50,0,0.8); }
    </style>
</head>
<body>

    <div class="col-list">
        <div class="tabs">
            <button class="tab-btn active" onclick="app.setTab('unit')">âš”ï¸ ìœ ë‹›</button>
            <button class="tab-btn" onclick="app.setTab('skill')">ğŸ”¥ ìŠ¤í‚¬</button>
            <button class="tab-btn" onclick="app.setTab('commander')">ğŸ‘‘ ì§€íœ˜ê´€</button>
        </div>
        <div style="padding:10px; border-bottom:1px solid var(--border);">
            <input type="text" id="search-input" placeholder="ì´ë¦„ ê²€ìƒ‰..." oninput="app.renderList()">
        </div>
        <div class="item-list" id="item-list"></div>
        <div style="padding:10px; border-top:1px solid var(--border);">
            <button class="primary" style="width:100%" onclick="app.createNew()">+ ìƒˆ ë°ì´í„° ë§Œë“¤ê¸°</button>
        </div>
    </div>

    <div class="col-edit" id="edit-panel">
        <div style="text-align:center; color:#555; margin-top:100px;">
            <h2>í¸ì§‘í•  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”</h2>
            <p>ë˜ëŠ” ìš°ì¸¡ í•˜ë‹¨ì—ì„œ [ë¶ˆëŸ¬ì˜¤ê¸°]ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.</p>
        </div>
    </div>

    <div class="col-preview">
        <h3>ğŸ‘ï¸ ë¯¸ë¦¬ë³´ê¸°</h3>
        <div class="preview-area">
            <div class="preview-overlay"></div>
            <div id="card-preview" class="card-preview-wrapper" style="display:none;"></div>
            <div id="cmd-preview" style="display:none; text-align:center; z-index:10; color:white;">
                <div style="width:120px; height:120px; background:#333; border:2px solid gold; border-radius:50%; margin:0 auto; display:flex; align-items:center; justify-content:center; font-size:40px;" id="cmd-img-box"></div>
                <h2 id="cmd-name-prev" style="margin-top:10px;">Name</h2>
                <p id="cmd-desc-prev" style="font-size:12px; color:#ccc; white-space:pre-wrap;">Description</p>
            </div>
        </div>

        <h3>ğŸ’¾ ë°ì´í„° ì…ì¶œë ¥ (data.js)</h3>
        <div class="code-area">
            <textarea id="io-textarea" class="code-output" placeholder="js/data.js ì „ì²´ ë‚´ìš©ì„ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”."></textarea>
            <div style="display:flex; gap:10px;">
                <button onclick="app.importData()" style="flex:1;">ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°</button>
                <button onclick="app.exportData()" class="primary" style="flex:1;">ğŸ“‹ ì „ì²´ ì½”ë“œ ìƒì„±</button>
            </div>
        </div>
    </div>

    <script>
        // [ê¸°ë³¸ í…œí”Œë¦¿ ë°ì´í„°] - ë¶ˆëŸ¬ì˜¤ê¸° ì „ ì´ˆê¸°ê°’
        const DEFAULT_DATA = {
            UNIT_STATS: {},
            SKILL_STATS: {},
            COMMANDERS: {}
        };

        // [SVG ë°ì´í„°] - ì´ë¯¸ì§€ ì—†ì„ ë•Œ SVGë¡œ ëŒ€ì²´ í‘œì‹œìš©
        const SVG_DATA = {
            'body_infantry': `<svg viewBox="0 0 64 64"><ellipse cx="32" cy="58" rx="16" ry="4" fill="#000" opacity="0.3"/><path d="M22 25 Q32 55 42 25" fill="#ccc" stroke="#000" stroke-width="2"/><rect x="22" y="22" width="20" height="26" rx="4" fill="#FFFFFF" stroke="#000" stroke-width="2"/><rect x="22" y="38" width="20" height="4" fill="#333"/><circle cx="32" cy="18" r="10" fill="#FFFFFF" stroke="#000" stroke-width="2"/><path d="M24 18 L40 18" stroke="#000" stroke-width="2"/></svg>`,
            'weapon_sword': `<svg viewBox="0 0 32 64"><g transform="translate(16, 45)"><path d="M-3 -35 L3 -35 L5 0 L-5 0 Z" fill="#FFFFFF" stroke="#000" stroke-width="2"/><rect x="-8" y="0" width="16" height="4" fill="#D4AF37" stroke="#000" stroke-width="1.5"/><rect x="-2" y="4" width="4" height="10" fill="#654321"/></g></svg>`,
            'weapon_bow': `<svg viewBox="0 0 32 64"><g transform="translate(10, 32)"><path d="M0 -25 Q 30 0 0 25" fill="none" stroke="#8B4513" stroke-width="4"/><line x1="0" y1="-25" x2="0" y2="25" stroke="#eee" stroke-width="1"/></g></svg>`
        };

        class DashboardApp {
            constructor() {
                this.data = JSON.parse(JSON.stringify(DEFAULT_DATA));
                this.currentTab = 'unit';
                this.selectedId = null;
                
                // SVG URL ìƒì„±
                this.svgUrls = {};
                for (const [k, v] of Object.entries(SVG_DATA)) {
                    const blob = new Blob([v], { type: 'image/svg+xml;charset=utf-8' });
                    this.svgUrls[k] = URL.createObjectURL(blob);
                }
            }

            // =========================================================================
            // ğŸ“‚ [í•µì‹¬] ë¶ˆëŸ¬ì˜¤ê¸° (Import) - ì˜¤ë¥˜ ìˆ˜ì •ë¨
            // =========================================================================
            importData() {
                const code = document.getElementById('io-textarea').value;
                if (!code.trim()) return alert("ì½”ë“œë¥¼ ë¶™ì—¬ë„£ì–´ì£¼ì„¸ìš”.");
                
                try {
                    // â˜… í•µì‹¬ ìˆ˜ì •: const ì¬ì„ ì–¸ ì˜¤ë¥˜ë¥¼ í”¼í•˜ê¸° ìœ„í•´
                    // ë³€ìˆ˜ ì„ ì–¸ ì—†ì´ ì‚¬ìš©ìì˜ ì½”ë“œë¥¼ ê·¸ëŒ€ë¡œ ì‹¤í–‰í•˜ê³ , ë§ˆì§€ë§‰ì— ê°ì²´ë§Œ ë¦¬í„´ë°›ìŠµë‹ˆë‹¤.
                    // ì‚¬ìš©ìê°€ 'const UNIT_STATS = ...'ë¼ê³  ì“´ ì½”ë“œê°€ ê·¸ëŒ€ë¡œ ì‹¤í–‰ë˜ë¯€ë¡œ
                    // ì´ í•¨ìˆ˜ ìŠ¤ì½”í”„ ë‚´ì—ì„œ í•´ë‹¹ ë³€ìˆ˜ê°€ ìƒì„±ë©ë‹ˆë‹¤.
                    const runner = new Function(`
                        ${code}
                        return {
                            UNIT_STATS: (typeof UNIT_STATS !== 'undefined') ? UNIT_STATS : {},
                            SKILL_STATS: (typeof SKILL_STATS !== 'undefined') ? SKILL_STATS : {},
                            COMMANDERS: (typeof COMMANDERS !== 'undefined') ? COMMANDERS : {}
                        };
                    `);
                    
                    const extracted = runner();
                    
                    if (Object.keys(extracted.UNIT_STATS).length > 0) this.data.UNIT_STATS = extracted.UNIT_STATS;
                    if (Object.keys(extracted.SKILL_STATS).length > 0) this.data.SKILL_STATS = extracted.SKILL_STATS;
                    if (Object.keys(extracted.COMMANDERS).length > 0) this.data.COMMANDERS = extracted.COMMANDERS;

                    alert("ë°ì´í„° ë¡œë“œ ì„±ê³µ! ë¦¬ìŠ¤íŠ¸ê°€ ê°±ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    this.renderList();
                } catch (e) {
                    console.error(e);
                    alert("ì½”ë“œ íŒŒì‹± ì‹¤íŒ¨!\nì˜¤ë¥˜ ë‚´ìš©: " + e.message + "\n\njs/data.js ì „ì²´ ë‚´ìš©ì„ ì •í™•íˆ ë³µì‚¬í–ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.");
                }
            }

            // =========================================================================
            // ğŸ“‹ [í•µì‹¬] ë‚´ë³´ë‚´ê¸° (Export) - ì›ë³¸ íŒŒì¼ êµ¬ì¡° ìœ ì§€
            // =========================================================================
            exportData() {
                const now = new Date().toISOString().split('T')[0];
                
                // ì›ë³¸ íŒŒì¼ì˜ êµ¬ì¡°ë¥¼ ìœ ì§€í•˜ê¸° ìœ„í•´ ì •ì  ë°ì´í„°ì™€ ë™ì  ë°ì´í„°ë¥¼ í•©ì¹©ë‹ˆë‹¤.
                let output = `// js/data.js (Edited via Dashboard ${now})\n\n`;
                
                // 1. ë°°ì¹˜ ì œí•œ ë“± ìƒìˆ˜
                output += `const DEPLOY_LIMIT = 266;\n\n`;

                // 2. ìœ ë‹› ë°ì´í„° (UNIT_STATS)
                output += `// ============================================================\n`;
                output += `// âš”ï¸ ìœ ë‹› ë°ì´í„° (Unit Stats)\n`;
                output += `// ============================================================\n`;
                output += `const UNIT_STATS = ${this.formatJSON(this.data.UNIT_STATS)};\n\n`;

                // 3. CC ê·œì¹™ (ë³€ê²½ì‚¬í•­ ì—†ìœ¼ë©´ í•˜ë“œì½”ë”©ëœ ê°’ ì‚¬ìš©)
                output += `// â˜… CCê¸° ê·œì¹™ ì •ì˜\n`;
                output += `const CC_RULES = {
    'STUN':      { canMove: false, canAttack: false, cancelCast: true,  msg: "ğŸ˜µ STUN" },
    'KNOCKBACK': { canMove: false, canAttack: false, cancelCast: true,  msg: "ğŸ”™ PUSH" },
    'SILENCE':   { canMove: true,  canAttack: true,  cancelCast: true,  msg: "ğŸ˜¶ SILENCE" },
    'ROOT':      { canMove: false, canAttack: true,  cancelCast: false, msg: "ğŸ”’ ROOT" },
    'SLOW':      { canMove: true,  canAttack: true,  cancelCast: false, msg: "ğŸŒ SLOW" }
};\n\n`;

                // 4. ì§€íœ˜ê´€ ë°ì´í„° (COMMANDERS)
                output += `// ============================================================\n`;
                output += `// ğŸ‘‘ ì§€íœ˜ê´€ ë°ì´í„°\n`;
                output += `// ============================================================\n`;
                output += `const COMMANDERS = ${this.formatJSON(this.data.COMMANDERS)};\n\n`;
                output += `let selectedCommander = 'artillery';\n\n`;

                // 5. ìŠ¤í‚¬ ë°ì´í„° (SKILL_STATS)
                output += `// ============================================================\n`;
                output += `// âœ¨ ìŠ¤í‚¬ ë°ì´í„° (Skill Stats)\n`;
                output += `// ============================================================\n`;
                output += `const SKILL_STATS = ${this.formatJSON(this.data.SKILL_STATS)};\n\n`;

                // 6. ë‚˜ë¨¸ì§€ ì •ì  ë°ì´í„° ë° í•¨ìˆ˜ (MAP_DATA, getEnemyStats ë“±)
                // â˜… ì‚¬ìš©ì íŒŒì¼ì˜ ë‚˜ë¨¸ì§€ ë¶€ë¶„ì„ ê·¸ëŒ€ë¡œ í…œí”Œë¦¿í™”
                output += `
const STARTER_DECK = [
    'Unit-ê²€ì‚¬', 'Unit-ì•”ì‚´ì', 'Unit-ì•”ì‚´ì',
    'Unit-ê¶ìˆ˜', 'Unit-ê¶ìˆ˜',
    'Unit-ë°©ë²½', 'Unit-ë°©ë²½',
    'Unit-ì•”ì‚´ì', 'Unit-ì•”ì‚´ì',
    'Skill-ëŒë©©ì´', 'Unit-íëŸ¬',
    'Skill-í™”ì—¼êµ¬', 
    'Skill-ë°©ì–´ë§‰'
];

const MAX_HAND = 7;
const MAX_COST = 50;
const RECOVERY_COST = 10;

let currentStage = 1;
let difficultyLevel = 0; 

const DIFFICULTY_MODS = {
    0: { hpMult: 1.0, dmgMult: 1.0, costPenalty: 0 }
};

for (let i = 1; i <= 20; i++) {
    DIFFICULTY_MODS[i] = {
        hpMult: 1.0 + (i * 0.1),   
        dmgMult: 1.0 + (i * 0.1),  
        costPenalty: Math.floor(i / 5) * -2 
    };
}

function getEnemyStats(name) {
    const base = UNIT_STATS[name];
    const mod = DIFFICULTY_MODS[difficultyLevel] || DIFFICULTY_MODS[0];

    if (name === 'ì êµ°' || name === 'ê¸°ì§€') {
        return {
            ...base,
            hp: Math.floor(base.hp * mod.hpMult),
            damage: Math.floor(base.damage * mod.dmgMult)
        };
    }
    return base;
}

const ENEMY_COMMANDERS = {
    1: { name: 'ì´ˆë³´ ê²€íˆ¬ì‚¬', deck: ['ì êµ°'], aiType: 'BASIC', baseCost: 5 },
    2: { name: 'ë°±ì¸ëŒ€ì¥', deck: ['ì êµ°', 'ê¶ìˆ˜', 'ê²€ì‚¬'], aiType: 'BALANCED', baseCost: 10 },
    3: { name: 'ì•”ì‚´ì ê¸¸ë“œì¥', deck: ['ì êµ°', 'ì•”ì‚´ì', 'ë°©ë²½'], aiType: 'TRICKY', baseCost: 12 },
    5: { name: 'í™”ì—¼ì˜ ë§ˆë²•ì‚¬', deck: ['ê²€ì‚¬', 'ë°©ë²½', 'í™”ì—¼êµ¬'], aiType: 'TACTICAL_AOE', baseCost: 12 }
};

const DEFAULT_ENEMY_COMMANDER = { 
    name: 'ë¬´ëª… ì§€íœ˜ê´€', deck: ['ì êµ°'], aiType: 'BASIC', baseCost: 15 
};

const MAP_DATA = {
    'DefaultMap': { 
        tileSize: 40, mapWidth: 25, mapHeight: 15, image: 'bg_battle',
        getGrid: function(w, h) { return Array(h).fill().map(() => Array(w).fill(0)); }
    },
    'Map1': { 
        tileSize: 40, mapWidth: 25, mapHeight: 15, image: 'bg_battle',
        getGrid: function(w, h) { 
            let grid = Array(h).fill().map(() => Array(w).fill(0));
            for(let y=0; y<h; y++) {
                grid[y][10] = 1; 
                if (y===4 || y===10) grid[y][10] = 0; 
            }
            for(let y=0; y<h; y++) {
                for(let x=0; x<5; x++) grid[y][x] = 2;
            }
            return grid;
        }
    }
};

function getMapData(id) {
    return MAP_DATA[id] || MAP_DATA['DefaultMap'];
}

// Global Registration
window.DEPLOY_LIMIT = DEPLOY_LIMIT;
window.UNIT_STATS = UNIT_STATS;
window.CC_RULES = CC_RULES;
window.COMMANDERS = COMMANDERS;
window.SKILL_STATS = SKILL_STATS;
window.STARTER_DECK = STARTER_DECK;
window.MAX_HAND = MAX_HAND;
window.MAX_COST = MAX_COST;
window.RECOVERY_COST = RECOVERY_COST;
window.ENEMY_COMMANDERS = ENEMY_COMMANDERS;
window.DEFAULT_ENEMY_COMMANDER = DEFAULT_ENEMY_COMMANDER;
window.getEnemyStats = getEnemyStats;
window.getMapData = getMapData;
`;

                const textarea = document.getElementById('io-textarea');
                textarea.value = output;
                textarea.select();
                document.execCommand('copy');
                alert("ì „ì²´ ì½”ë“œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! js/data.js íŒŒì¼ì— ë®ì–´ì”Œìš°ì„¸ìš”.");
            }

            formatJSON(obj) {
                // ë³´ê¸° ì¢‹ê²Œ í¬ë§·íŒ… (í‚¤ì˜ ë”°ì˜´í‘œ ì œê±°)
                const json = JSON.stringify(obj, null, 4);
                return json.replace(/"([^"]+)":/g, '$1:');
            }

            // =========================================================================
            // UI ë¡œì§ (íƒ­, ë¦¬ìŠ¤íŠ¸, í¼)
            // =========================================================================
            setTab(tab) {
                this.currentTab = tab;
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                event.target.classList.add('active');
                this.selectedId = null;
                this.renderList();
                document.getElementById('edit-panel').innerHTML = '<div style="text-align:center; margin-top:100px; color:#555;">í¸ì§‘í•  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”</div>';
                document.getElementById('card-preview').style.display = 'none';
                document.getElementById('cmd-preview').style.display = 'none';
            }

            getDataGroup() {
                if (this.currentTab === 'unit') return this.data.UNIT_STATS;
                if (this.currentTab === 'skill') return this.data.SKILL_STATS;
                return this.data.COMMANDERS;
            }

            renderList() {
                const listEl = document.getElementById('item-list');
                const search = document.getElementById('search-input').value.toLowerCase();
                const group = this.getDataGroup();
                
                listEl.innerHTML = '';
                
                Object.keys(group).forEach(key => {
                    if (key.toLowerCase().includes(search)) {
                        const item = group[key];
                        const div = document.createElement('div');
                        div.className = `list-item ${this.selectedId === key ? 'active' : ''}`;
                        div.innerHTML = `
                            <div>
                                <div style="font-weight:bold; color:#fff;">${key}</div>
                                <div class="item-sub">${item.name || key} | Cost: ${item.cost !== undefined ? item.cost : '-'}</div>
                            </div>
                            <div style="font-size:18px;">${this.getItemIcon(item)}</div>
                        `;
                        div.onclick = () => this.selectItem(key);
                        listEl.appendChild(div);
                    }
                });
            }

            getItemIcon(item) {
                if (this.currentTab === 'unit') return 'âš”ï¸';
                if (this.currentTab === 'skill') return 'ğŸ”¥';
                return 'ğŸ‘‘';
            }

            createNew() {
                const id = prompt("ìƒˆ IDë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ë¬¸ ê¶Œì¥):");
                if (!id) return;
                
                const group = this.getDataGroup();
                if (group[id]) return alert("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” IDì…ë‹ˆë‹¤.");

                // ê¸°ë³¸ í…œí”Œë¦¿ ë³µì œ
                let template = {};
                if (this.currentTab === 'unit') {
                    // ê²€ì‚¬ê°€ ìˆìœ¼ë©´ ë³µì‚¬, ì—†ìœ¼ë©´ ê¸°ë³¸ê°’
                    template = this.data.UNIT_STATS['ê²€ì‚¬'] ? JSON.parse(JSON.stringify(this.data.UNIT_STATS['ê²€ì‚¬'])) : { cost: 3, hp: 100, damage: 10, range: 50, speed: 50 };
                } else if (this.currentTab === 'skill') {
                    template = this.data.SKILL_STATS['í™”ì—¼êµ¬'] ? JSON.parse(JSON.stringify(this.data.SKILL_STATS['í™”ì—¼êµ¬'])) : { cost: 3, damage: 30, radius: 50 };
                } else {
                    template = this.data.COMMANDERS['knight'] ? JSON.parse(JSON.stringify(this.data.COMMANDERS['knight'])) : { name: 'ìƒˆ ì§€íœ˜ê´€', hp: 1000 };
                }
                
                template.name = "New " + id;
                group[id] = template;
                this.selectItem(id);
                this.renderList();
            }

            selectItem(id) {
                this.selectedId = id;
                this.renderList();
                this.renderForm(id);
                this.updatePreview();
            }

            // === [í¼ ìƒì„±ê¸°] ===
            renderForm(id) {
                const group = this.getDataGroup();
                const item = group[id];
                const panel = document.getElementById('edit-panel');
                
                let html = `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h2>${id} <span style="font-size:14px; color:#777;">(${this.currentTab})</span></h2>
                        <button class="danger" onclick="app.deleteItem('${id}')">ì‚­ì œ</button>
                    </div>
                    <div class="form-grid">
                `;

                // í•„ë“œ ìë™ ìƒì„± (traits, desc, bonus ê´€ë ¨ í•„ë“œëŠ” ì œì™¸í•˜ê³  ìë™ ìƒì„±)
                const skipKeys = ['traits', 'desc', 'bonusTime', 'bonusEffect'];
                Object.keys(item).forEach(key => {
                    if (skipKeys.includes(key)) return;

                    const val = item[key];
                    const type = typeof val;
                    
                    if (type === 'number' || type === 'string') {
                        html += `
                            <div class="form-group">
                                <label>${key.toUpperCase()}</label>
                                <input type="${type === 'number' ? 'number' : 'text'}" 
                                    value="${val}" 
                                    step="${key.includes('Speed') || key.includes('time') || key.includes('duration') ? '0.1' : '1'}"
                                    onchange="app.updateField('${key}', this.value, '${type}')">
                            </div>
                        `;
                    }
                });
                html += `</div>`; // Grid End

                // ì„¤ëª… (TextArea)
                html += `
                    <div class="form-group">
                        <label>DESCRIPTION (ì„¤ëª…)</label>
                        <textarea rows="3" onchange="app.updateField('desc', this.value)">${item.desc || ''}</textarea>
                    </div>
                `;

                // ì „ëµ ë³´ë„ˆìŠ¤ (UNIT/SKILL)
                if (this.currentTab !== 'commander') {
                    // JSON í¸ì§‘ê¸° í˜•íƒœë¡œ ê°„ë‹¨íˆ ì œê³µ
                    html += `
                        <div class="form-group" style="background:#222; padding:10px; border-radius:4px;">
                            <label style="color:#ffcc00;">â˜… ì „ëµ ë³´ë„ˆìŠ¤ (ì‹œê°„/íš¨ê³¼)</label>
                            <div class="form-grid">
                                <div>
                                    <label>Bonus Time [ì‹œì‘, ë]</label>
                                    <input type="text" value="${JSON.stringify(item.bonusTime || [])}" 
                                    onchange="app.updateJsonField('bonusTime', this.value)">
                                </div>
                                <div>
                                    <label>Bonus Effect {stat, val}</label>
                                    <input type="text" value='${JSON.stringify(item.bonusEffect || {})}' 
                                    onchange="app.updateJsonField('bonusEffect', this.value)">
                                </div>
                            </div>
                        </div>
                    `;
                }

                // íŠ¹ì„± (Tag Input) - ìœ ë‹›ì¸ ê²½ìš°ë§Œ
                if (this.currentTab === 'unit') {
                    html += `
                        <div class="form-group">
                            <label>TRAITS (íŠ¹ì„± - ì—”í„°ë¡œ ì¶”ê°€)</label>
                            <div class="tags-container" onclick="document.getElementById('trait-input').focus()">
                                ${ (item.traits || []).map((t, idx) => `
                                    <span class="tag ${t==='ë³´ë³‘'?'tag-race':''}">${t} <span class="tag-remove" onclick="app.removeTrait(${idx})">Ã—</span></span>
                                `).join('') }
                                <input type="text" id="trait-input" class="tag-input" placeholder="+Tag" onkeydown="app.addTrait(event)">
                            </div>
                            <div style="margin-top:5px; display:flex; gap:5px;">
                                <button onclick="app.addTraitDirect('ë³´ë³‘')" style="font-size:10px;">+ë³´ë³‘</button>
                                <button onclick="app.addTraitDirect('ì¹¨íˆ¬')" style="font-size:10px;">+ì¹¨íˆ¬</button>
                                <button onclick="app.addTraitDirect('ì€ì‹ ')" style="font-size:10px;">+ì€ì‹ </button>
                            </div>
                        </div>
                    `;
                }

                panel.innerHTML = html;
            }

            updateField(key, value, type) {
                const group = this.getDataGroup();
                if (type === 'number') value = parseFloat(value);
                group[this.selectedId][key] = value;
                this.updatePreview();
                this.renderList(); 
            }

            updateJsonField(key, valueStr) {
                try {
                    const parsed = JSON.parse(valueStr);
                    const group = this.getDataGroup();
                    group[this.selectedId][key] = parsed;
                    // ì„±ê³µ ì‹œ ë³„ë„ ì•Œë¦¼ ì—†ìŒ
                } catch (e) {
                    alert("JSON í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (ì˜ˆ: [0, 5] ë˜ëŠ” {\"stat\":\"hp\", \"val\":10})");
                }
            }

            deleteItem(id) {
                if (!confirm(`ì •ë§ '${id}' ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
                const group = this.getDataGroup();
                delete group[id];
                this.selectedId = null;
                this.renderList();
                document.getElementById('edit-panel').innerHTML = '';
                document.getElementById('card-preview').style.display = 'none';
            }

            // === [íŠ¹ì„± ê´€ë¦¬] ===
            removeTrait(idx) {
                const item = this.data.UNIT_STATS[this.selectedId];
                item.traits.splice(idx, 1);
                this.renderForm(this.selectedId);
                this.updatePreview();
            }

            addTrait(e) {
                if (e.key === 'Enter') {
                    const val = e.target.value.trim();
                    if (val) this.addTraitDirect(val);
                }
            }

            addTraitDirect(val) {
                const item = this.data.UNIT_STATS[this.selectedId];
                if (!item.traits) item.traits = [];
                if (!item.traits.includes(val)) {
                    item.traits.push(val);
                    this.renderForm(this.selectedId);
                    this.updatePreview();
                }
            }

            // === [ë¯¸ë¦¬ë³´ê¸°] ===
            updatePreview() {
                const cardEl = document.getElementById('card-preview');
                const cmdEl = document.getElementById('cmd-preview');
                const group = this.getDataGroup();
                const item = group[this.selectedId];

                if (this.currentTab === 'commander') {
                    cardEl.style.display = 'none';
                    cmdEl.style.display = 'block';
                    
                    document.getElementById('cmd-name-prev').innerText = item.name;
                    document.getElementById('cmd-desc-prev').innerText = item.desc;
                    const color = item.color ? '#' + item.color.toString(16).padStart(6, '0') : '#aaa';
                    document.getElementById('cmd-img-box').style.background = color;
                    document.getElementById('cmd-img-box').innerText = item.name ? item.name[0] : 'C';
                } else {
                    cmdEl.style.display = 'none';
                    cardEl.style.display = 'block';
                    
                    const frameClass = (this.currentTab === 'unit') ? 'frame-unit' : 'frame-skill';
                    
                    // ì´ë¯¸ì§€ (SVG ì¡°í•©)
                    let imgHtml = '';
                    if (this.currentTab === 'unit') {
                        let body = 'body_infantry';
                        let weapon = null;
                        
                        // ì´ë¦„ì´ë‚˜ ì´ë¯¸ì§€ í‚¤ë¥¼ ë³´ê³  íŒŒì¸  ì¶”ì¸¡
                        const imgKey = item.image || '';
                        if (imgKey.includes('archer')) weapon = 'weapon_bow';
                        else if (imgKey.includes('healer') || imgKey.includes('mage')) { body = 'body_robe'; weapon = 'weapon_staff'; }
                        else if (imgKey.includes('sword')) weapon = 'weapon_sword';
                        
                        // SVG í•©ì„±
                        const s1 = this.svgUrls[body] ? `<img src="${this.svgUrls[body]}" style="position:absolute; width:100%; height:100%;">` : '';
                        const s2 = (weapon && this.svgUrls[weapon]) ? `<img src="${this.svgUrls[weapon]}" style="position:absolute; width:50%; height:100%; left:30%; top:10%;">` : '';
                        imgHtml = `<div style="position:relative; width:100%; height:100%;">${s1}${s2}</div>`;
                    } else {
                        imgHtml = '<div style="font-size:50px; display:flex; justify-content:center; align-items:center; height:100%;">ğŸ”¥</div>';
                    }

                    // ìŠ¤íƒ¯ HTML
                    let statsHtml = '';
                    if (this.currentTab === 'unit') {
                        statsHtml = `
                            <div class="stat-badge stat-atk">${item.damage}</div>
                            <div class="stat-badge stat-hp">${item.hp}</div>
                        `;
                    }
                    
                    // íŠ¹ì„± HTML
                    let traitsHtml = '';
                    if (item.race) traitsHtml += `<span class="trait-tag tag-race">${item.race}</span>`;
                    if (item.traits) item.traits.forEach(t => traitsHtml += `<span class="trait-tag">${t}</span>`);

                    cardEl.innerHTML = `
                        <div class="card">
                            <div class="card-bg-img" style="background:#222; overflow:hidden;">${imgHtml}</div>
                            <div class="card-frame ${frameClass}"></div>
                            <div class="card-cost">${item.cost !== undefined ? item.cost : '-'}</div>
                            <div class="card-name">${item.name}</div>
                            <div class="card-traits">${traitsHtml}</div>
                            <div class="card-type">${this.currentTab.toUpperCase()}</div>
                            ${statsHtml}
                        </div>
                    `;
                }
            }
        }

        const app = new DashboardApp();
    </script>
</body>
</html>